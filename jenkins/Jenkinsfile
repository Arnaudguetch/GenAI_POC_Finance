pipeline {
    agent any

    environment {
        IMAGE_NAME = "genai_app"
        STREAMLIT_CONTAINER = "streamlit_app"
        DATA_HOST_PATH = "${WORKSPACE}/data"
        

    }

    stages {
        stage("Checkout develop-branch") {
            steps {
                script {
                    echo "Checkout develop-branch"
                    sh '''
                      git fetch origin develop-branch
                      git checkout -B develop-branch origin/develop-branch
                    '''
                }
            }
        }

        stage("Build Docker Image") {
            steps {
                script {
                    echo "Build image Docker (contexte = racine)"
                    sh 'docker build -t ${IMAGE_NAME} -f dockerfile/Dockerfile .'
                }
            }
        }

        stage("Run main.py (ML)") {
            steps {
                script {
                    echo "Exécution de main.py dans un conteneur (avec /data monté)"
                    sh '''
                      mkdir -p ${WORKSPACE}/data
                      docker run --rm -v ${WORKSPACE}/data:/data ${IMAGE_NAME} python3 /source/main.py
                    '''
                }
            }
        }

        stage("Checkout test-branch") {
            steps {
                script {
                    echo "Checkout test-branch"
                    sh '''
                      git fetch origin test-branch
                      git checkout -B test-branch origin/test-branch
                    '''
                }
            }
        }

        stage("Run Unit Tests (using test-branch code)") {
            steps {
                script {
                    echo "Lancement des tests unitaires depuis test-branch..."
                    sh """
                        docker build -t genai_poc_finance -f dockerfile/Dockerfile .
                    """
                    sh """
                        rm -rf /tmp/test-branch
                        git clone -b test-branch https://github.com/Arnaudguetch/GenAI_POC_Finance.git /tmp/test-branch
                        ls -l /tmp/test-branch
                        docker run --rm \\
                            -v /tmp/test-branch:/source \\
                            -v /tmp/test-branch/data:/data \\
                            -w /source \\
                            genai_poc_finance \\
                            bash -lc 'export PYTHONPATH=/source && pytest tests/test_main.py --maxfail=1 --disable-warnings -q'
                    """
                }
            }
        }

        stage("Deploy Streamlit App (detached)") {
            steps {
                script {
                    echo "Déploiement Streamlit (démarrage détaché)"
                    sh '''
                      STREAMLIT_CONTAINER=streamlit_app
                      IMAGE_NAME=genai_app
                      HOST_PORT=8501

                      docker rm -f ${STREAMLIT_CONTAINER} 2>/dev/null || true

                      EXISTING=$(docker ps --filter "publish=$HOST_PORT" --format "{{.ID}}")
                      if [ ! -z "$EXISTING" ]; then
                          docker rm -f $EXISTING
                      fi

                      docker run -d --name ${STREAMLIT_CONTAINER} -p $HOST_PORT:8501 \
                        -v ${WORKSPACE}/data:/data \
                        ${IMAGE_NAME} 

                      echo "Streamlit accessible sur le port $HOST_PORT"
                    '''
                }
            }
        }
    }

    post {
        always {
            echo "======== Pipeline terminé ========"
        }
        success {
            echo "======== Pipeline exécuté avec succès! ========="
        }
        failure {
            echo "======== Pipeline échoué! ========="
        }
    }
}


