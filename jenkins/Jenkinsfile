pipeline {
    agent any
    
    environment {
        DOCKER_COMPOSE = "docker-compose -f docker-compose.yml"
        PYTHON = "python3"
        IMAGE_NAME = "genai_poc_finance_source"
    }

    stages {
        stage("Checkout") {
            steps {
                checkout scm
            }
        }

        stage("Build Docker Image (source)") {
            steps {
                script { 
                    echo "ðŸ‘‰ Construction de l'image Docker pour source..."
                    sh "docker build -t ${IMAGE_NAME} -f dockerfile/Dockerfile ./source"
                }
            }
        }

        stage("Run ML from develop-branch") {
            steps {
                script {
                    echo "ðŸ‘‰ ExÃ©cution de main.py depuis develop-branch..."
                    sh "git fetch origin develop-branch:develop-branch"
                    sh "git checkout develop-branch"
                    sh "${PYTHON} source/main.py"
                }
            }
        }

        stage("Unit Tests from test-branch") {
            steps {
                script {
                    echo "ðŸ‘‰ Lancement des tests unitaires depuis test-branch..."
                    sh "git fetch origin test-branch:test-branch"
                    sh "git checkout test-branch"
                    sh "pytest tests/test_main.py --maxfail=1 --disable-warnings -q"
                }
            }
        }

        stage("Deploy to Master") {
            steps {
                script {
                    echo "ðŸ‘‰ DÃ©ploiement sur master..."
                    sh "git fetch origin master:master"
                    sh "git checkout master"
                    sh "${DOCKER_COMPOSE} down"
                    sh "${DOCKER_COMPOSE} up -d --build"
                }
            }
        }
    }

    post {
        always {
            echo "======== Pipeline terminÃ© ========"
        }
        success {
            echo "======== Pipeline exÃ©cutÃ© avec succÃ¨s ========"
        }
        failure {
            echo "======== Pipeline Ã©chouÃ© ========"
        }
    }
}
