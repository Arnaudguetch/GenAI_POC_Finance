pipeline {
    agent any
    
    environment {
        DOCKER_COMPOSE = "docker-compose -f docker-compose.yml"
        IMAGE_NAME = "genai_poc_finance_source"
    }

    stages {
        stage("Checkout") {
            steps {
                checkout scm
            }
        }

        stage("Build Docker Image (source)") {
            steps {
                script { 
                    echo "üëâ Construction de l'image Docker pour source..."
                    sh "docker build -t ${IMAGE_NAME} -f dockerfile/Dockerfile ./source"
                }
            }
        }

        stage("Run ML from develop-branch") {
            steps {
                script {
                    echo "Ex√©cution de main.py depuis develop-branch..."
                    sh "docker run --rm ${IMAGE_NAME}"
                }
            }
        }

        stage("Unit Tests from test-branch") {
            steps {
                script {
                    echo "Lancement des tests unitaires depuis test-branch..."
                    sh "docker run --rm -v \$(pwd)/tests:/source/tests ${IMAGE_NAME} pytest tests/test_main.py --maxfail=1 --disable-warnings -q"
                }
            }
        }

        stage("Deploy to Master") {
            steps {
                script {
                    echo "D√©ploiement sur master..."
                    sh "${DOCKER_COMPOSE} down"
                    sh "${DOCKER_COMPOSE} up -d --build"
                }
            }
        }
    }

    post {
        always {
            echo "======== Pipeline termin√© ========"
        }
        success {
            echo "======== Pipeline ex√©cut√© avec succ√®s ========"
        }
        failure {
            echo "======== Pipeline √©chou√© ========"
        }
    }
}
